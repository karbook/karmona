# ğŸ“¦ This file is moved to the root directory before building the image

# ğŸ§± Base Bun image (Linux-compatible)
FROM oven/bun:1 AS base

# ğŸŒ Set production environment variables
ENV NODE_ENV=production
ENV PORT="8080"

# ğŸ” Sentry environment configuration
ARG COMMIT_SHA
ENV COMMIT_SHA=$COMMIT_SHA

# ğŸ” 1Password CLI token and environment
ARG OP_SERVICE_ACCOUNT_TOKEN
ENV OP_SERVICE_ACCOUNT_TOKEN=$OP_SERVICE_ACCOUNT_TOKEN

# ğŸ”‘ API Key de Resend
ARG RESEND_API_KEY
ENV RESEND_API_KEY=$RESEND_API_KEY

# ğŸ§° Install required system packages for 1Password CLI
RUN apt-get update && apt-get install -y curl unzip jq && apt-get clean

# ğŸ“¥ Copy OP CLI binary from official image
COPY --from=1password/op:2 /usr/local/bin/op /usr/local/bin/op

# ğŸ“¦ Dependency stage â€“ installs all modules
FROM base AS deps
WORKDIR /app
COPY package.json bun.lock ./
RUN bun install --frozen-lockfile

# ğŸ“¦ Production-only dependencies stage
FROM base AS production-deps
WORKDIR /app
COPY --from=deps /app/node_modules /app/node_modules
COPY package.json bun.lock ./
RUN bun install --production

# ğŸ—ï¸ Build stage â€“ compile and prepare the app
FROM base AS build
WORKDIR /app
COPY --from=deps /app/node_modules /app/node_modules
COPY . .

# ğŸ§¬ Generate type definitions for react-router (optional)
RUN bun run typegen

# âš ï¸ Inject Sentry token as environment variable and run production build
ARG SENTRY_AUTH_TOKEN
ENV SENTRY_AUTH_TOKEN=$SENTRY_AUTH_TOKEN
RUN bun run build

# ğŸ§¼ Final production image â€“ minimal and ready to run
FROM base
WORKDIR /app

# ğŸšš Copy dependencies
COPY --from=production-deps /app/node_modules /app/node_modules

# ğŸšš Copy build artifacts and required files
COPY --from=build /app/build /app/build
COPY --from=build /app/public /app/public
COPY --from=build /app/package.json /app/package.json
COPY --from=build /app/app/components/ui/icons /app/app/components/ui/icons

COPY . .

# ğŸš€ Start the Bun server
CMD ["bun", "run", "start"]
